## Домашнее задание по теме: "Spark SQL"

Цель: изучить датасет по заболеваемости ковид-19 и получить навык работы с DataFrame API

1. Выберите 15 стран с наибольшим процентом переболевших на 31 марта (в выходящем датасете необходимы колонки: iso_code, страна, процент переболевших)

    #### Результат:

    ```python
    from pyspark.sql.functions import *
    
    df = (spark.read.option('header', True)
                    .option('sep', ',')
                    .option('inferSchema', True)
                    .csv('owid-covid-data.csv'))
    
    (df.where((col('date') == '2020-03-31')
              & (~col('iso_code').like('%OWID_%')))
       .orderBy(col('total_cases').desc())
       .select('iso_code',
               col('location').alias('страна'),
               (round((col('total_cases') - col('total_deaths')) / col('population') * 100, 3)).alias('процент переболевших'))
       .limit(15)
       .show())
    ```
    ```
    +--------+--------------+--------------------+
    |iso_code|        страна|процент переболевших|
    +--------+--------------+--------------------+
    |     USA| United States|               0.056|
    |     ITA|         Italy|               0.154|
    |     ESP|         Spain|               0.187|
    |     CHN|         China|               0.005|
    |     DEU|       Germany|               0.085|
    |     FRA|        France|               0.072|
    |     IRN|          Iran|                0.05|
    |     GBR|United Kingdom|               0.054|
    |     CHE|   Switzerland|               0.187|
    |     TUR|        Turkey|               0.016|
    |     BEL|       Belgium|               0.104|
    |     NLD|   Netherlands|               0.068|
    |     AUT|       Austria|               0.112|
    |     KOR|   South Korea|               0.019|
    |     CAN|        Canada|               0.022|
    +--------+--------------+--------------------+
    ```

2. Top 10 стран с максимальным зафиксированным кол-вом новых случаев за последнюю неделю марта 2021 в отсортированном порядке по убыванию (в выходящем датасете необходимы колонки: число, страна, кол-во новых случаев)

    #### Результат:

    ```python
    (df.where((col('date').between('2021-03-29', '2021-03-31'))
              & (~col('iso_code').like('%OWID_%')))
       .orderBy(col('new_cases').desc())
       .select(date_format('date', 'yyyy-MM-dd').alias('число'),
               col('location').alias('страна'),
               col('new_cases').alias('кол-во новых случаев'))
       .limit(10)
       .show())
    ```
    ```
    +----------+-------------+--------------------+
    |     число|       страна|кол-во новых случаев|
    +----------+-------------+--------------------+
    |2021-03-31|       Brazil|             90638.0|
    |2021-03-30|       Brazil|             84494.0|
    |2021-03-31|        India|             72330.0|
    |2021-03-29|United States|             69429.0|
    |2021-03-31|United States|             67039.0|
    |2021-03-30|United States|             61249.0|
    |2021-03-31|       France|             59054.0|
    |2021-03-29|        India|             56211.0|
    |2021-03-30|        India|             53480.0|
    |2021-03-31|       Turkey|             39302.0|
    +----------+-------------+--------------------+
    ```

3. Посчитайте изменение случаев относительно предыдущего дня в России за последнюю неделю марта 2021. (например: в россии вчера было 9150 , сегодня 8763, итог: -387) (в выходящем датасете необходимы колонки: число, кол-во новых случаев вчера, кол-во новых случаев сегодня, дельта)

    #### Результат:

    ```python
    from pyspark.sql.window import Window

    (df.where((col('date').between('2021-03-28', '2021-03-31'))
              & (col('iso_code') == 'RUS'))
       .withColumn("кол-во новых случаев вчера",lag('new_cases').over(Window.orderBy("date")))
       .select(date_format('date', 'yyyy-MM-dd').alias('число'),
               col('new_cases').alias('кол-во новых случаев сегодня'),
               'кол-во новых случаев вчера',
               (col('кол-во новых случаев вчера') - col('new_cases')).alias('дельта'))
       .where(col('date') != '2021-03-28')
       .show())
    ```
    ```
    +----------+----------------------------+--------------------------+------+
    |     число|кол-во новых случаев сегодня|кол-во новых случаев вчера|дельта|
    +----------+----------------------------+--------------------------+------+
    |2021-03-29|                      8589.0|                    8979.0| 390.0|
    |2021-03-30|                      8162.0|                    8589.0| 427.0|
    |2021-03-31|                      8156.0|                    8162.0|   6.0|
    +----------+----------------------------+--------------------------+------+
    ```
